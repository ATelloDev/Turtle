<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Turtle Conver - Login</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --turtle-50:#f3faf5;
      --turtle-100:#e4f5ea;
      --turtle-200:#c8ebd6;
      --turtle-300:#a3ddb9;
      --turtle-400:#7ccf9b;
      --turtle-500:#2fb76d; /* verde más intenso */
      --turtle-600:#1f8b56; /* más profundo para acentos */
      --turtle-700:#2e824d;
      --turtle-800:#25673d;
      --turtle-900:#1d5231;
      --ink:#183028;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background: radial-gradient(1200px 800px at 80% -10%, var(--turtle-100), transparent),
                  radial-gradient(1200px 800px at -20% 120%, var(--turtle-200), transparent),
                  linear-gradient(160deg, var(--turtle-50), #ffffff 60%);
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .brand{
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
      user-select: none;
    }
    .logo{
      width: 42px; height: 42px; border-radius: 12px;
      background: conic-gradient(from 210deg, var(--turtle-600), var(--turtle-500));
      display:grid; place-items:center;
      box-shadow: 0 8px 24px rgba(58,167,99,0.25), inset 0 2px 6px rgba(255,255,255,.35);
      position: relative; overflow: hidden;
    }
    .logo:before{
      content:""; position:absolute; inset:0;
      background: radial-gradient(60% 60% at 30% 20%, rgba(255,255,255,.35), transparent 60%);
    }
    .logo svg{ width: 24px; height: 24px; color: #eafff2; filter: drop-shadow(0 1px 2px rgba(0,0,0,.25)); }
    .brand h1{ font-size: 22px; margin:0; letter-spacing: .3px; }
    .brand small{ display:block; color: #2f7f5a; font-weight: 600; margin-top: -2px; }

    .card{
      width: min(420px, 100%);
      background: #ffffffcc;
      backdrop-filter: blur(8px);
      border-radius: 18px;
      padding: 28px;
      box-shadow:
        0 20px 60px rgba(58,167,99,0.22),
        0 2px 6px rgba(0,0,0,.05),
        inset 0 1px 0 rgba(255,255,255,.7);
      border: 1px solid #e7f5ec;
      position: relative;
    }

    .card:after{
      content:""; position:absolute; inset: -2px; z-index:-1; border-radius: 20px;
      background: linear-gradient(135deg, #ffffff 0%, #e6f7ee 40%, #ffffff 100%);
      filter: blur(12px); opacity:.7;
    }

    .title{ font-size: 26px; margin: 6px 0 14px; font-weight: 600; letter-spacing: .2px; }
    .subtitle{ margin: 0 0 20px; color: #3a7356; }

    form{ display: grid; gap: 14px; }

    label{ font-size: 13px; font-weight: 600; color:#346b50; }

    .input, select{
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #d7ecdf;
      outline: none;
      background: #fbfffd;
      color: var(--ink);
      transition: box-shadow .2s, border-color .2s, transform .06s ease-out;
    }
    .input:focus, select:focus{
      border-color: var(--turtle-500);
      box-shadow: 0 0 0 4px rgba(47,183,109,.22);
    }

    .row{ display:flex; gap: 12px; }
    .row > * { flex: 1; }

    .btn{
      appearance: none; border: 0; cursor: pointer; font-weight: 700;
      padding: 12px 16px; border-radius: 12px; color: white;
      background: linear-gradient(135deg, var(--turtle-600), var(--turtle-500));
      box-shadow: 0 8px 20px rgba(58,167,99,.35), inset 0 -2px 0 rgba(0,0,0,.08);
      transition: transform .06s ease-out, box-shadow .2s ease, filter .2s;
    }
    .btn:hover{ filter: brightness(1.02); box-shadow: 0 10px 26px rgba(58,167,99,.42); }
    .btn:active{ transform: translateY(1px); box-shadow: 0 6px 16px rgba(58,167,99,.35); }

    .helper{
      display:flex; align-items:center; justify-content: space-between; gap: 12px;
      font-size: 12px; color:#3a7356;
    }

    .divider{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap: 10px; color:#3a7356; font-size: 12px; }
    .divider:before, .divider:after{ content:""; height:1px; background: #dcefe4; }

    .footer{ margin-top: 14px; font-size: 12px; color:#3a7356; text-align:center; }

    .select-wrap { position: relative; }
    .select-wrap:after{
      content:""; position:absolute; right:12px; top:50%; transform: translateY(-50%);
      border: 6px solid transparent; border-top-color:#346b50; pointer-events:none;
    }

    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background: #ecf8f0; color:#2f7f5a; font-size:12px; font-weight:600;
    }

    @media (max-width: 420px){
      .title{ font-size: 22px; }
    }
  </style>
</head>
<body>
  <main class="card" role="main" aria-labelledby="title">
    <div class="brand" aria-label="Turtle Conver">
      <div class="logo" aria-hidden="true">
        <!-- Turtle icon -->
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 3c-4.418 0-8 2.91-8 6.5S7.582 16 12 16s8-2.91 8-6.5S16.418 3 12 3Zm-6.5 8.5c.828 0 1.5.672 1.5 1.5s-.672 1.5-1.5 1.5S4 13.828 4 13s.672-1.5 1.5-1.5Zm13 0c.828 0 1.5.672 1.5 1.5s-.672 1.5-1.5 1.5S14 13.828 14 13s.672-1.5 1.5-1.5ZM9.5 17.25c0-.414.336-.75.75-.75h3.5a.75.75 0 0 1 0 1.5H10.25a.75.75 0 0 1-.75-.75Z"/>
        </svg>
      </div>
      <div>
        <h1>Turtle Conver</h1>
        <small>Bienvenido</small>
      </div>
    </div>

    <h2 id="title" class="title">Sign in</h2>
    <p class="subtitle">Accede para continuar. Guarda y reutiliza usuarios fácilmente.</p>

    <form id="loginForm" autocomplete="on" aria-describedby="helper">
      <div class="row">
        <div>
          <label for="username">Usuario o email</label>
          <input id="username" name="username" class="input" type="text" placeholder="p.ej. juan.perez" required />
        </div>
        <div class="select-wrap">
          <label for="savedUsers">Usuarios guardados</label>
          <select id="savedUsers" name="savedUsers" class="input" aria-label="Usuarios guardados">
            <option value="" selected>Seleccionar...</option>
          </select>
        </div>
      </div>

      <div>
        <label for="password">Contraseña</label>
        <input id="password" name="password" class="input" type="password" placeholder="••••••••" required />
      </div>

      <div class="helper" id="helper">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
          <input type="checkbox" id="remember" /> Recuérdame
        </label>
        <span class="chip" title="Tus datos se almacenan localmente en tu navegador">Local</span>
      </div>

      <button type="submit" class="btn" aria-label="Iniciar sesión">Iniciar sesión</button>

      <div class="divider" role="separator" aria-hidden="true">o</div>

      <div class="footer">
        ¿No tienes cuenta? Usa cualquier usuario. El guardado es local en tu navegador.
      </div>
    </form>
  </main>

  <script type="module">
    import { Api } from './assets/api.js';
    (function(){
      const STORAGE_KEY = 'turtle_conver_users';
      const CLEAR_VALUE = '__clear__';

      const form = document.getElementById('loginForm');
      const username = document.getElementById('username');
      const password = document.getElementById('password');
      const remember = document.getElementById('remember');
      const select = document.getElementById('savedUsers');

      const loadUsers = () => {
        try{
          const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
          return Array.isArray(data) ? data : [];
        }catch{ return []; }
      };

      const saveUsers = (arr) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      };

      const renderSelect = () => {
        const users = loadUsers();
        select.innerHTML = '';
        const optDefault = document.createElement('option');
        optDefault.value = '';
        optDefault.textContent = 'Seleccionar...';
        select.appendChild(optDefault);

        users.forEach(u => {
          const opt = document.createElement('option');
          opt.value = u;
          opt.textContent = u;
          select.appendChild(opt);
        });

        if(users.length){
          const divider = document.createElement('option');
          divider.disabled = true;
          divider.textContent = '────────────';
          select.appendChild(divider);

          const clear = document.createElement('option');
          clear.value = CLEAR_VALUE;
          clear.textContent = 'Limpiar login';
          select.appendChild(clear);
        }
      };

      const addUser = (u) => {
        const clean = String(u || '').trim();
        if(!clean) return;
        const users = loadUsers();
        if(!users.includes(clean)){
          users.push(clean);
          saveUsers(users);
        }
      };

      const clearUsers = () => {
        localStorage.removeItem(STORAGE_KEY);
      };

      // Prefill if remembered
      (function init(){
        renderSelect();
        const last = sessionStorage.getItem('turtle_conver_last');
        if(last) username.value = last;
      })();

      select.addEventListener('change', (e) => {
        const val = e.target.value;
        if(val === CLEAR_VALUE){
          clearUsers();
          renderSelect();
          username.value = '';
          username.focus();
          return;
        }
        if(val){
          username.value = val;
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const u = username.value.trim();
        const p = password.value;
        try{
          const resp = await Api.login(u, p);
          if(!resp?.ok) throw new Error(resp?.message || 'Login fallido');
          localStorage.setItem('tc_token', resp.token);
          localStorage.setItem('tc_user', JSON.stringify(resp.user));
          if(remember.checked){ addUser(u); renderSelect(); }
          sessionStorage.setItem('turtle_conver_last', u);
          window.location.href = resp.user?.role === 'admin' ? 'admin.html' : 'home.html';
        }catch(err){
          alert(err.message || 'Error de autenticación');
        }
      });
    })();
  </script>
</body>
</html>
